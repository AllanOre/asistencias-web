<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asistencia charla Preoperativa</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;padding:18px}
    .card{background:#fff;border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);max-width:980px;margin:0 auto}
    h2{margin-top:0}
    select,input,button{padding:8px;margin:6px 0;}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    .motivo{display:none}
    #gpsInfo{font-weight:600;margin-top:8px}
    .actions{margin-top:12px}
    .small{font-size:13px;color:#555}
    .saved-box{background:#e9f8ec;border:1px solid #c7f0d1;padding:10px;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">

    <label>Seleccione subsede</label>
    <select id="subsedeSelect" required>
      <option value="">-- Seleccione --</option>
    </select>

    <div id="tablaContainer"></div>

    <div class="actions">
      <button id="btnGPS">Obtener ubicaci√≥n y hora</button>
      <input type="file" id="fotoCharla" accept="image/*" required>
      <button id="btnGuardar">Guardar asistencia</button>
    </div>

    <p id="gpsInfo"></p>
    <div id="saved" class="saved-box" style="display:none"></div>
  </div>

<script type="module">

/* ---------------------------------------------------------
   IMPORTS FIREBASE
--------------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-storage.js";

/* ---------------------------------------------------------
   CONFIG FIREBASE
--------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDTsxsKwaTO-pty9_evddybAZaw_nHMYls",
  authDomain: "sigehnd-d30d9.firebaseapp.com",
  projectId: "sigehnd-d30d9",
  storageBucket: "sigehnd-d30d9.firebasestorage.app",
  messagingSenderId: "411489599817",
  appId: "1:411489599817:web:e2343e05a3697e9be11a98",
  measurementId: "G-T1HBEHVYZM"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);

/* ---------------------------------------------------------
   DATOS
--------------------------------------------------------- */
const DATA = {};

Object.assign(DATA, {
  "Santa Rosa": [
    "Erick Mauricio Perez","Manuel Antonio Quintanilla Mejia","Osmel Yonatan Sanchez Rodriguez",
    "Marco Tulio Abrego Robles","Brayan Josue Torres Leon","Danilo Armando Erazo Ard√≥n",
    "Edwin Alexander Villatoro Chavez","Elmer Daniel Melgar Madrid","Francis Eduardo Vasquez",
    "Gerson Orlando Marquez Milla","Victor Hugo Fuentes Sanchez","Nerin Omar Villeda Caceres",
    "Raimer Wiliams Banegas Dubon","Tulio Javier Prado","Marvin Obel Marquez Guardado",
    "Gelman Adalid Fuentes Portillo"
  ],
  "Gracias": [
    "Brayan Mauricio Lopez Miranda","Rommel Jose Alfaro Sanchez","Keldin Yoneri Alvarado Ortega",
    "Osmy Orlando Serrano Martinez","Fredy Mauricio Castellanos Hernandez","Wilson Adonis Serrano Vasquez",
    "Eduardo Josue Guerra Cuevar","Carlos Roberto Perez Espinoza","Elvin Alexis Martinez Alvarado",
    "Jose Alberto Quintanilla Orellana","Jose Ariel Gomez Cruz","Jose Neftaly Mateo Vasquez",
    "Oliver Sebastian Quintanilla Miranda","Pablo Jose Trejo Bejarano","Wilber Fabricio Alvarado Casta√±eda",
    "Jos√© Daniel Aguirre Aguilar"
  ],
  "La Entrada": [
    "Marvin Antonio Bojorge Sanchez","Cristian Emilio Balderramos Santos","Cristian Josue Sarmiento Reyes",
    "Denis Omar Bueso Carranza","Joaquin Alejandro Rodriguez Villanu","Mario Rene Polanco Montoya",
    "Victor Antonio Santos Garcia","Jose Alberto Galdamez Serrano","Axel Armando Rosendo Vasquez"
  ],
  "Cop√°n Ruinas": [
    "Erlin Onel Lara Interiano","Denilson Fabricio Pineda Garcia","Luis Alonzo Vega Ramos",
    "Luis Armando Arita Rosa","Orlin Jesus Garcia Rosales"
  ],
  "San Marcos": [
    "Darlin Murillo Navas","Jefry Josue Garcia Romero","Luis Angel Villeda Maldonado",
    "Marcos Gabarrete Gabarrete","Alejandro Jose Garcia Lara"
  ],
  "Ocotepeque": [
    "Luis Alfonso Orellana Linares","Edas Erminio Oliva Lopez","Jossue Anael Brito Hernandez",
    "Julio Cesar Mejia Cribas","Kevin Javier Ramos Peraza","Melvin Josue Uma√±a Sarmiento",
    "Walter Roel Arita Rosa","Carlos Eduardo Landaverde Peraza","Evenilson Danil Guillen Hernandez",
    "Hosana Sananda Hernandez Vega"
  ]
});

const motivos = ["Vacaciones","Incapacidad","No se present√≥","Permiso autorizado","Reparto","Falla Mecanica"];

const subsedeSelect = document.getElementById('subsedeSelect');
const tablaContainer = document.getElementById('tablaContainer');
const btnGPS = document.getElementById('btnGPS');
const gpsInfo = document.getElementById('gpsInfo');
const btnGuardar = document.getElementById('btnGuardar');
const fotoCharla = document.getElementById('fotoCharla');
const savedBox = document.getElementById('saved');

/* ---------------------------------------------------------
   RELLENAR SUBSEDES
--------------------------------------------------------- */
Object.keys(DATA).forEach(s => {
  const o = document.createElement('option');
  o.value = s;
  o.textContent = s;
  subsedeSelect.appendChild(o);
});

/* ---------------------------------------------------------
   TABLA
--------------------------------------------------------- */
subsedeSelect.addEventListener('change', () => renderTabla(subsedeSelect.value));

function renderTabla(sub){
  if(!sub) { tablaContainer.innerHTML=''; return; }
  const list = DATA[sub];
  let html = '<table><thead><tr><th>Inspector</th><th>Se present√≥?</th><th>Motivo</th></tr></thead><tbody>';
  list.forEach((name,idx)=>{
    html += `<tr>
      <td>${name}</td>
      <td>
        <label><input type="radio" name="p${idx}" value="si" required onchange="handlePres(${idx},true)"> S√≠</label>
        <label style="margin-left:8px"><input type="radio" name="p${idx}" value="no" required onchange="handlePres(${idx},false)"> No</label>
      </td>
      <td>
        <select id="motivo_${idx}" class="motivo">
          <option value="">--Seleccione--</option>
          ${motivos.map(m=>`<option value="${m}">${m}</option>`).join('')}
        </select>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  tablaContainer.innerHTML = html;
}

window.handlePres = function(i,isSi){
  const s = document.getElementById('motivo_'+i);
  if(!s) return;
  s.style.display = isSi ? 'none' : 'inline-block';
};

/* ---------------------------------------------------------
   GPS
--------------------------------------------------------- */
let lastGPS = null;

btnGPS.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('GPS no disponible'); return; }
  gpsInfo.textContent = 'Obteniendo ubicaci√≥n...';

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);

    /* ‚è∞ AQUI EST√Å EL FORMATO 24 H */
    const hora = new Date().toLocaleTimeString("es-HN", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    });

    lastGPS = {lat,lon,hora};
    gpsInfo.textContent = `Hora: ${hora} | Ubicaci√≥n: ${lat}, ${lon}`;
  },err=>{  
    alert('Error al obtener GPS: '+err.message); 
    gpsInfo.textContent='';
  });
});

/* ---------------------------------------------------------
   GUARDAR (GOOGLE SHEETS)
--------------------------------------------------------- */
btnGuardar.addEventListener('click', async ()=>{

  const sub = subsedeSelect.value;
  if(!sub){ alert('Selecciona una subsede'); return; }

  if(fotoCharla.files.length === 0){
    alert("Debes subir una foto obligatoriamente.");
    return;
  }

  if(!lastGPS){
    alert("Debes obtener la ubicaci√≥n antes de guardar.");
    return;
  }

  const list = DATA[sub];
  const registros = [];

  for(let idx = 0; idx < list.length; idx++){
    const radios = document.getElementsByName('p'+idx);
    let pres = null;

    for(const r of radios){ if(r.checked) pres = r.value; }

    if(!pres){
      alert(`Debes marcar SI o NO para: ${list[idx]}`);
      return;
    }

    let motivo = "";
    if(pres === "no"){
      const sel = document.getElementById("motivo_"+idx);
      if(!sel.value){
        alert(`Debes seleccionar un motivo para: ${list[idx]}`);
        return;
      }
      motivo = sel.value;
    }

    registros.push({ inspector:list[idx], present: pres==="si", reason: motivo });
  }

  const fotoFile = fotoCharla.files[0];

  await guardarSheet(sub, registros, fotoFile);
});

/* ---------------------------------------------------------
   FUNCI√ìN PARA GUARDAR EN GOOGLE SHEETS
--------------------------------------------------------- */
async function guardarSheet(sub, registros, fotoFile) {

  const storageRef = ref(storage, `asistencias/${sub}_${Date.now()}.jpg`);
  await uploadBytes(storageRef, fotoFile);
  const fotoURL = await getDownloadURL(storageRef);

  const payload = {
    subsede: sub,
    gps: lastGPS,
    fotoURL: fotoURL,
    registros: registros
  };

  // üö® IMPORTANTE: sin headers para evitar preflight (OPTIONS)
  await fetch("https://script.google.com/macros/s/AKfycbwlhOGJmyd6xrIq6vHLL9GiAb-OMAUbjSf8Vuewxisi_6JkNHG7atoyD5yROR8Pm08XSg/exec", {
    method: "POST",
    body: JSON.stringify(payload)
  });

  savedBox.style.display = "block";
  savedBox.textContent = "Asistencia guardada correctamente en Google Sheets ‚úîÔ∏è";
}

</script>
</body>
</html>
